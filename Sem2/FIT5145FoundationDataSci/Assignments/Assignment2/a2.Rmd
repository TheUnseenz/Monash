# FIT5145: Foundation of Data Science
## Assignment 2
### Student ID: 27030768

A data analysis on Australia's waste generation, recovery and fate.
We will start by loading and cleaning the data.
Data cleaning done in this first step:
1. "Category" column is found to have inconsistent names.  
  - For consistency, every category ending with s is converted to singular form.  
  - "&" is converted to "and".  
  - "hw" and "toxic waste" are converted to "hazardous waste" as they mean the same.
2. There are a few values in "Category" that are missing,  
and a few that are incorrectly encoded.  
  - Categories that have fewer than 10 entries are converted to match the Category  
    that most commonly contains its Type.  
    
```{r} 
# Change directory to file location
library(this.path)
setwd(this.path::here())

library(dplyr)
library(stringr) # For string manipulation
library(ggplot2)
library(broom)
wastes <- read.csv("Wastes.csv")

# Data cleaning
# Clean the Category column
wastes <- wastes %>%
    mutate(
        Category = tolower(Category),
        # Remove trailing "s" only if the preceding letter is not "s" or "i"
        Category = str_replace(Category, "(?<![si])s$", ""),
        Category = str_replace(Category, "&", "and"),
        Category = str_trim(Category),
        Category = ifelse(Category == "hw", "hazardous waste", Category),
        Category = ifelse(Category == "toxic waste", "hazardous waste", Category),
    )

# Identify mappings between Type and the most frequent Category for that Type
type_category_map <- wastes %>%
    filter(!is.na(Category) & Category != "") %>%
    group_by(Type, Category) %>%
    summarise(n = n(), .groups = "drop") %>%
    arrange(Type, desc(n)) %>%
    group_by(Type) %>%
    slice_head(n = 1) %>%
    ungroup() %>%
    select(Type, Most_Common_Category = Category)

wastes_before_recoding <- wastes # Keep a full copy before recoding

print("--- Category Sums Before Recoding ---")
print(wastes %>% group_by(Category) %>% summarise(Total_Tonnes_Before = sum(Tonnes, na.rm = TRUE), n_before = n(), .groups = "drop") %>% arrange(Category))

# Recode missing and low-frequency Categories based on Type
wastes <- wastes %>%
    left_join(type_category_map, by = "Type", suffix = c("", "_matched")) %>%
    mutate(
        Category = ifelse(is.na(Category) | Category == "" | (Category %in% (wastes %>% count(Category) %>% filter(n < 10) %>% pull(Category))),
            Most_Common_Category,
            Category
        )
    ) %>%
    select(-Most_Common_Category)

# Calculate sums after recoding
print("--- Category Sums After Recoding ---")
print(wastes %>% group_by(Category) %>% summarise(Total_Tonnes = sum(Tonnes, na.rm = TRUE), n_after = n(), .groups = "drop") %>% arrange(Category))

# # --- Check the rows where Category was recoded (either originally missing or low frequency) ---
# low_freq_categories <- wastes %>%
#     count(Category) %>%
#     filter(n < 10) %>%
#     pull(Category)

# recoded_rows <- wastes %>%
#     mutate(
#         Was_Originally_Missing = is.na(wastes_before_recoding$Category) | wastes_before_recoding$Category == "",
#         Was_Low_Frequency = Category %in% low_freq_categories,
#         Should_Be_Recoded = Was_Originally_Missing | Was_Low_Frequency
#     ) %>%
#     filter(Should_Be_Recoded) %>%
#     left_join(wastes_before_recoding %>% select(Original_Category = Category, row_id = row_number()), by = "row_id") %>%
#     select(Type, Original_Category, Recoded_Category = Category) %>%
#     arrange(Type)

# print("--- Rows Where Category Was Expected to Be Recoded ---")
# print(recoded_rows)

# # --- Check for any remaining missing categories ---
# remaining_missing <- sum(is.na(wastes$Category) | wastes$Category == "")
# print(paste("--- Remaining Missing Categories:", remaining_missing, "---"))

# Now 'wastes' has the potentially imputed 'Category' column, and you have
# information printed to the console to help diagnose the summation issue.
```
1.  How many unique “Category” values are there in the data file (6 marks)? 
```{r} 
unique_categories <- unique(wastes$Category)
print(length(unique_categories))
# unique_types <- unique(wastes$Type)
# print(unique_types)
```
2.  How  many  negative  feedback  comments  are  in  the  'Description'  column  with  an 
environmental impact score of 2 or 3 (4 marks)? 
```{r} 
negative_env_score <- length(grep(" 3/10.| 2/10.", wastes$Description))
print(negative_env_score)
# Data cleaning time: inconsistent categories
```
3.  For each Category value, write code to calculate the fractions of waste tonnes of different 
waste sources, and then draw a chart to visualise the fraction numbers specific to the Category 
value (3 marks). 
```{r} 
# Calculate the sum of 'value' for each category

category_sums <- wastes %>%
    group_by(Category) %>%
    summarise(Total_Category_Wastes = sum(Tonnes, na.rm = TRUE)) %>%
    arrange(desc(Total_Category_Wastes))

# Convert Category to a factor with levels in the desired order
category_sums$Category <- factor(category_sums$Category, levels = category_sums$Category)

# Print the category sums (optional, but good to check)
print(category_sums)

category_chart <- ggplot(category_sums, aes(x = Category, y = Total_Category_Wastes, fill = Category)) +
    geom_bar(stat = "identity") +
    labs(title = "Total Waste Tonnes by Category", x = "Category", y = "Total Waste Tonnes", fill = "Category") +
    theme_minimal() +
    theme(
        axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "right"
    ) +
    scale_fill_hue(l = 60, c = 80) # Use a rainbow-like hue scale

print(category_chart)

# # Calculate percentages and angles for labels
# category_sums <- category_sums %>%
#   mutate(percentage = Total_Category_Wastes / sum(Total_Category_Wastes),
#          angle = cumsum(percentage) - 0.5 * percentage,
#          angle = angle * 180 / pi, # Convert angle to degrees
#          hjust = ifelse(angle < 90 | angle > 270, "left", "right"))
#
# # Create the pie chart
# pie_chart <- ggplot(category_sums, aes(x = "", y = Total_Category_Wastes, fill = Category)) +
#   geom_bar(stat = "identity", width = 1) +
#   coord_polar("y", start = 0) +
#   labs(title = "Distribution of Total Waste Tonnes by Category", fill = "Category") +
#   theme_void() +
#   theme(legend.position = "right") +
#   geom_text(aes(y = Total_Category_Wastes / 2 + c(0, cumsum(Total_Category_Wastes)[-nrow(category_sums)]),
#                 label = paste0(round(percentage * 100, 1), "%")),
#             size = 3, nudge_x = 1) +
#   scale_fill_hue(l = 60, c = 80) # Use a rainbow-like hue scale
#
# # Display the pie chart
# print(pie_chart)
```
4.  Please add the 'Year' and 'State' values from Year_State_ID.csv to Wastes.csv, compute the 
total waste tonnes for each year and state, and store the result in a dataset named 'temp'. Then, 
use a single R function/command to display the statistical information (i.e., Min, Max, and 
Mean)  of  the  total  waste  tonnes  for  each  state  in  ‘temp’  (Note: You may use multiple 
functions/commands  to  prepare  the pre-processed data table, but when you compute and 
display the statistical information, you need to use a single R function/command.) (6 marks). 
```{r} 
year_state <- read.csv("Year_State_ID.csv")
# Merge the data frames based on the common identifier
wastes_merged <- merge(wastes, year_state[, c("ID", "Year", "State", "Economic_Growth")], by.x = "Year_State_ID", by.y = "ID", all.x = FALSE)
wastes_merged$ID <- NULL
temp <- wastes_merged %>%
    filter(State != "Australia") %>%
    group_by(State) %>%
    summarise(
        Total_Tonnes = sum(Tonnes, na.rm = TRUE),
        Mean_Tonnes = mean(Tonnes, na.rm = TRUE),
        Median_Tonnes = median(Tonnes, na.rm = TRUE),
        SD_Tonnes = sd(Tonnes, na.rm = TRUE),
        Min_Tonnes = min(Tonnes, na.rm = TRUE),
        Max_Tonnes = max(Tonnes, na.rm = TRUE),
        Q1_Tonnes = quantile(Tonnes, 0.25, na.rm = TRUE),
        Q3_Tonnes = quantile(Tonnes, 0.75, na.rm = TRUE),
        n = n() # Number of observations for each state
    )

print("--- Summary of Total Waste Tonnes by State ---")
print(temp)

# temp <- wastes_merged %>%
#     group_by(Year, State) %>%
#     summarise(Total_Waste_Tonnes = sum(Tonnes, na.rm = TRUE))

# temp <- aggregate(Tonnes ~ Year + State, data = wastes, sum)
# summary(temp)
```
```{r}
temp <- aggregate(Tonnes ~ State,
    data = wastes_merged,
    FUN = function(x) {
        c(
            Min = min(x, na.rm = TRUE),
            Max = max(x, na.rm = TRUE),
            Mean = mean(x, na.rm = TRUE)
        )
    }
)

print("--- Min, Max, and Mean of Total Waste Tonnes by State ---")
print(temp)
```

```{r}
# wastes_merged$Year <- as.numeric(sub("-.*", "", wastes$Year))
```
5.  Write code to draw a chart showing a yearly trend of total waste tonnes of food organics for 
each state. To draw the chart, please convert the Year-Year formats of all Year values into Year 
formats (3 marks).  
```{r} 
library(ggplot2)
# Extract only the first year of the range
wastes_merged$Year <- as.numeric(sub("-.*", "", wastes_merged$Year))


# Assuming you have a column named 'Type' in your 'wastes_merged' data frame
specified_type <- "Food organics" # Replace with the actual Type value you're interested in

# Filter data for the specified Type
waste_type_yearly <- wastes_merged %>%
    filter(Type == specified_type) %>%
    group_by(Year, State) %>%
    summarise(Total_Waste_Tonnes = sum(Tonnes, na.rm = TRUE), .groups = "drop")

# Create the line chart
yearly_trend_chart <- ggplot(waste_type_yearly, aes(x = Year, y = Total_Waste_Tonnes, color = State)) +
    geom_line() +
    geom_point() +
    labs(
        title = paste("State breakdown of total waste of", specified_type),
        x = "Year",
        y = "Total Waste Tonnes",
        color = "State"
    ) +
    theme_minimal() +
    theme(legend.position = "right")

# Display the chart
print(yearly_trend_chart)
```
6.  Write code to display the most recycled waste Type and the most disposed waste Type with the 
corresponding year. Write code to display the most increased waste Type over years (4 marks). 
```{r} 
# Most Recycled Waste Type and Year
most_recycled <- wastes_merged %>%
    filter(Fate == "Recycling") %>%
    group_by(Year, Type) %>%
    summarise(Total_Recycled = sum(Tonnes, na.rm = TRUE), .groups = "drop") %>%
    arrange(desc(Total_Recycled)) %>%
    slice_head(n = 1) %>%
    select(Year, Type, Total_Recycled)

cat("--- Most Recycled Waste ---\n")
cat(paste("Type:", most_recycled$Type, "\n"))
cat(paste("Year:", most_recycled$Year, "\n"))
cat(paste("Total Recycled (Tonnes):", most_recycled$Total_Recycled, "\n\n"))

# Most Disposed Waste Type and Year
most_disposed <- wastes_merged %>%
    filter(Fate == "Disposal") %>%
    group_by(Year, Type) %>%
    summarise(Total_Disposed = sum(Tonnes, na.rm = TRUE), .groups = "drop") %>%
    arrange(desc(Total_Disposed)) %>%
    slice_head(n = 1) %>%
    select(Year, Type, Total_Disposed)

cat("--- Most Disposed Waste ---\n")
cat(paste("Type:", most_disposed$Type, "\n"))
cat(paste("Year:", most_disposed$Year, "\n"))
cat(paste("Total Disposed (Tonnes):", most_disposed$Total_Disposed, "\n\n"))


# Most Increased Waste Type Over the Years
yearly_waste_trends <- wastes_merged %>%
    group_by(Year, Type) %>%
    summarise(Total_Tonnes = sum(Tonnes, na.rm = TRUE), .groups = "drop") %>%
    arrange(Year, Type)

most_increased <- yearly_waste_trends %>%
    group_by(Type) %>%
    summarise(
        First_Year_Tonnes = first(Total_Tonnes),
        Last_Year_Tonnes = last(Total_Tonnes),
        Increase = Last_Year_Tonnes - First_Year_Tonnes,
        .groups = "drop"
    ) %>%
    arrange(desc(Increase)) %>%
    slice_head(n = 1) %>%
    select(Type, Increase)

cat("--- Most Increased Waste (by Tonnes) ---\n")
cat(paste("Type:", most_increased$Type, "\n"))
cat(paste("Increase (Tonnes):", most_increased$Increase, "\n"))
```
7.  Please investigate the factors influencing environmental impact scores. (Note: You may use 
variables  from  both  Wastes.csv  and  Year_State_ID.csv  for  your analysis.) Marks will be 
awarded based on the depth of your investigation (including analyses and discussions) and the 
strength of your reasoning (how insights and conclusions are drawn) (5 marks). 
```{r} 
# Assuming your data frame is named 'wastes_merged' and contains the relevant columns
# 'Description', 'Economic_Growth', 'Tonnes', 'Stream', 'Fate', 'Core_Non-core', 'Category', 'Type'

# Extract the Environmental Impact Score
wastes_impact <- wastes_merged %>%
    mutate(
        Impact_Score_Text = str_extract(Description, "Environmental Impact Score: [0-9]+/10\\."),
        Environmental_Impact_Score = as.numeric(str_extract(Impact_Score_Text, "[0-9]+"))
    ) %>%
    filter(!is.na(Environmental_Impact_Score)) # Keep only rows with scores

# Convert categorical variables to factors for regression
wastes_impact <- wastes_impact %>%
    mutate(
        Stream = as.factor(Stream),
        Fate = as.factor(Fate),
        Core_Non_core = as.factor(`Core_Non.core`), # Be mindful of the hyphen
        Category = as.factor(Category),
        Type = as.factor(Type)
    )

# Multiple Regression Analysis
# Include all relevant predictors
model <- lm(Environmental_Impact_Score ~ Economic_Growth + Tonnes + Stream +
    Fate + `Core_Non.core` + Category + Type, data = wastes_impact)

tidy_model <- tidy(model)
# Filter for statistically significant terms (p-value < 0.05)
tidy_model <- tidy_model %>%
    filter(p.value < 0.05) %>%
    print(tidy_model)

# print("\nMultiple Regression Analysis Summary:")
summary(model)

# Check model assumptions (optional but important for interpreting results)
# You might want to look at residual plots, normality of residuals, etc.
# plot(model)
```
```{r} 
```
8.  Write code to only keep data records where the Category value is Hazardous wastes, the Type 
value is Tyres (T140) and  tonnes value is more than 0, then write code to add a new column 
named  “Tonnes_range”  and  fill  it  with  one  of  the  following  values  based  on  the 
corresponding “Tonnes” value: 
○        [0, 10000) 
○        [10000, 20000) 
○        [20000, 40000) 
○        [40000, 80000] 

Then, for each state, display a chart to show the number of cases of different score_range 
values. What do you observe? (4 marks) 
```{r} 
# Filter the data
filtered_tyres <- wastes_merged %>%
    filter(Category == "hazardous waste", Type == "Tyres (T140)", Tonnes > 0)

# Add the Tonnes_range column
filtered_tyres <- filtered_tyres %>%
    mutate(
        Tonnes_range = case_when(
            Tonnes >= 0 & Tonnes < 10000 ~ "1",
            Tonnes >= 10000 & Tonnes < 20000 ~ "2",
            Tonnes >= 20000 & Tonnes < 40000 ~ "3",
            Tonnes >= 40000 & Tonnes <= 80000 ~ "4",
            TRUE ~ NA_character_ # Handle any values outside the specified ranges
        ),
        Tonnes_range = as.factor(Tonnes_range) # Convert to categorical factor
    )

# Count the number of cases for each Tonnes_range within each State
state_tonnes_range_counts <- filtered_tyres %>%
    group_by(State, Tonnes_range) %>%
    summarise(n = n(), .groups = "drop")

# Create the bar chart
tonnes_range_by_state_chart <- ggplot(
    state_tonnes_range_counts,
    aes(x = State, y = n, fill = Tonnes_range)
) +
    geom_bar(stat = "identity", position = "dodge") +
    labs(
        title = "Number of Tyres (T140) Cases by Tonnes Range and State",
        x = "State",
        y = "Number of Cases",
        fill = "Tonnes Range"
    ) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Display the chart
print(tonnes_range_by_state_chart)
```
9.  Using both original datasets and external sources, please investigate the factors influencing 
the yearly trend of total C&D waste tonnes. Marks will be awarded based on the depth of your 
investigation (including analyses and discussions) and the strength of your reasoning (how 
insights and conclusions are drawn). (Note: Please provide the source links for any external 
data used) (7 marks). 

```{r} 
# 1. Calculate Total Waste Tonnes per Year across all streams
total_yearly_waste <- wastes_merged %>%
    group_by(Year) %>%
    summarise(Total_All_Waste_Tonnes = sum(Tonnes, na.rm = TRUE), .groups = "drop")

# 2. Aggregate C&D Waste by Year, keeping other potential predictors
yearly_cd_data <- wastes_merged %>%
    filter(Stream == "C&D") %>%
    group_by(Year, Economic_Growth, Fate, Category, Type) %>%
    summarise(Total_C_D_Tonnes = sum(Tonnes, na.rm = TRUE), .groups = "drop")

# 3. Merge Total Yearly Waste with C&D Yearly Data
yearly_cd_trends <- yearly_cd_data %>%
    left_join(total_yearly_waste, by = "Year")

# Convert categorical variables to factors for regression
yearly_cd_trends <- yearly_cd_trends %>%
    mutate(
        Fate = as.factor(Fate),
        Category = as.factor(Category),
        Type = as.factor(Type)
    )

# 4. Multiple Regression Analysis
# Include total yearly waste as a predictor
model_cd_yearly_all <- lm(
    Total_C_D_Tonnes ~ Economic_Growth + Total_All_Waste_Tonnes +
        Fate + Category + Type,
    data = yearly_cd_trends
)

# Get the tidy output
tidy_model_cd_yearly_all <- tidy(model_cd_yearly_all)

# Filter for statistically significant terms (p-value < 0.05)
significant_terms_cd_yearly_all <- tidy_model_cd_yearly_all %>%
    filter(p.value < 0.05) %>%
    arrange(desc(abs(estimate)))

print("Statistically Significant Factors Influencing Yearly C&D Waste Tonnes (Including Total Yearly Waste):")
print(significant_terms_cd_yearly_all)

# You might also want to look at the summary of the model
print("\nSummary of the Yearly C&D Waste Regression Model (Including Total Yearly Waste):")
summary(model_cd_yearly_all)
```
```{r} 
# Assuming your data frame is named 'wastes_merged' and contains the relevant columns
# 'Year', 'Economic_Growth', 'Tonnes', 'Stream', 'Fate', 'Core_Non.core', 'Category', 'Type'

# 1. Filter for C&D Waste
cd_waste <- wastes_merged %>%
    filter(Stream == "C&D")

# 2. Aggregate by Year to get Total Yearly C&D Tonnes
yearly_cd_tonnes <- cd_waste %>%
    group_by(Year, Economic_Growth, Fate, Category, Type) %>%
    summarise(Total_C_D_Tonnes = sum(Tonnes, na.rm = TRUE), .groups = "drop")

# Convert categorical variables to factors for regression
yearly_cd_tonnes <- yearly_cd_tonnes %>%
    mutate(
        Fate = as.factor(Fate),
        Category = as.factor(Category),
        Type = as.factor(Type)
    )

# 3. Multiple Regression Analysis
# Include all relevant predictors
model_cd_yearly <- lm(
    Total_C_D_Tonnes ~ Economic_Growth +
        Fate + Category + Type,
    data = yearly_cd_tonnes
)

# Get the tidy output
tidy_model_cd_yearly <- tidy(model_cd_yearly)

# Filter for statistically significant terms (p-value < 0.05)
significant_terms_cd_yearly <- tidy_model_cd_yearly %>%
    filter(p.value < 0.05) %>%
    arrange(desc(abs(estimate)))

print("Statistically Significant Factors Influencing Yearly C&D Waste Tonnes:")
print(significant_terms_cd_yearly)

# You might also want to look at the summary of the model
print("\nSummary of the Yearly C&D Waste Regression Model:")
summary(model_cd_yearly)
```